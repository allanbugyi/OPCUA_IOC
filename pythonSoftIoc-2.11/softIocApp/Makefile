##########################################################################
# Copyright (c) 2003 The University of Chicago, as Operator of Argonne
#     National Laboratory.
# Copyright (c) 2003 The Regents of the University of California, as
#     Operator of Los Alamos National Laboratory.
# EPICS BASE Versions 3.13.7 and higher are distributed subject to the
# Software License Agreement found in the file LICENSE that is included
# with this distribution.
##########################################################################

TOP=..

include $(TOP)/configure/CONFIG


# Discover the correct name for the python library
PYTHON_LIB := python$(shell $(PYTHON) -c 'from distutils import sysconfig; \
    print sysconfig.get_config_var("VERSION")')


USR_CFLAGS += -std=gnu99 -Werror

USR_CFLAGS += $(shell $(PYTHON_CONFIG) --cflags)

# This tells the compiler to ignore errors generated by EPICS includes.  We need
# this because the EPICS headers have non strict prototypes in places.
USR_CPPFLAGS += -isystem $(EPICS_BASE)/include


PROD_IOC_DEFAULT = softIoc
PROD_IOC_vxWorks = -nil-

DBD += softIoc.dbd
softIoc_DBD += base.dbd

USR_CFLAGS += -DEPICS_BASE='"$(shell cd "$(EPICS_BASE)" && pwd)"'

softIoc_SRCS += softIoc_registerRecordDeviceDriver.cpp
softIoc_SRCS += softMain.c

softIoc_LIBS += $(EPICS_BASE_IOC_LIBS) PythonSupport

# The following definitions of Python libraries works for both static and
# dynamic Python.  Note that we need to move the $(PYTHON_LIB) definition from
# LDFLAGS to _LIBS so we can configure the library directory.
softIoc_LDFLAGS += \
    $(filter-out -l$(PYTHON_LIB),$(shell $(PYTHON_CONFIG) --ldflags))
softIoc_LIBS += $(PYTHON_LIB)
$(PYTHON_LIB)_DIR = $(shell $(PYTHON_CONFIG) --exec-prefix)/lib


# Support for devIocStats
#softIoc_DBD += devIocStats.dbd
#softIoc_LIBS += devIocStats
#DB += $(DEVIOCSTATS)/db/ioc.db


# ----------------------------------------------------------------------
# Support library for python component, dynamically loaded to assist with
# access to record fields.


LIBRARY_IOC += PythonSupport

# The following are compiled and added to the support library
PythonSupport_SRCS += PythonSupport.c

PythonSupport_LIBS += $(EPICS_BASE_IOC_LIBS)


# include $(TOP)/configure/RULES_TOP
include $(TOP)/configure/RULES
